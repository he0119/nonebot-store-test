<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>商店测试结果</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/bootstrap-table@1.22.0/dist/bootstrap-table.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <style>
      .ok {
        color: rgb(9, 231, 39);
        font-size: 1.5em;
      }

      .err {
        color: red;
        font-size: 1.5em;
      }

      .show-log {
        color: rgb(42, 95, 243);
        font-size: 1.5em;
      }

      .package {
        color: rgb(151, 151, 151);
        font-size: 0.95em;
      }

      .account {
        color: rgb(151, 151, 151);
        font-size: 1.5em;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1 class="text-center">商店测试结果</h1>
      <table
        id="table"
        data-show-columns="true"
        data-search="true"
        data-mobile-responsive="true"
        data-check-on-init="true"
        data-pagination="true"
      >
        <thead>
          <tr>
            <th data-field="project_link" data-formatter="projectFormatter" data-sortable="true">
              PyPI 项目名<br /><span class="mdi mdi-package package">包名</span>
            </th>
            <th data-field="author" data-formatter="authorFormatter" data-sortable="true">作者</th>
            <th
              data-field="run"
              data-formatter="runFormatter"
              data-sortable="true"
            >
              加载结果
            </th>
            <th
              data-field="valid"
              data-formatter="validFormatter"
              data-sortable="true"
            >
              验证结果
            </th>
            <th data-field="metadata" data-formatter="metadataFormatter">
              元数据
            </th>
            <th data-field="time" data-sortable="true">测试时间</th>
          </tr>
        </thead>
      </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>

    <script src="https://unpkg.com/bootstrap-table@1.22.0/dist/bootstrap-table.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.22.0/dist/extensions/mobile/bootstrap-table-mobile.min.js"></script>

    <script>
      const check_pass = `<span class="mdi mdi-check-circle-outline ok"></span>`;
      const check_fail = `<span class="mdi mdi-close-circle-outline err"></span>`;
      const show_log = `<span class="mdi mdi-package-variant show-log"></span>`;
      $.getJSON(
        "https://raw.githubusercontent.com/he0119/nonebot-store-test/main/results/results.json",
        function (data) {
          var items = [];
          $.each(data, function (key, val) {
            items.push({
              time: val.time,
              project_link: val.previous.project_link,
              module_name: val.previous.module_name,
              author: val.previous.author,
              run: val.run ? check_pass : check_fail,
              valid: val.valid ? check_pass : check_fail,
              metadata: val.metadata,
              output: val.output,
              validation_message: val.validation_message,
              homepage: val.previous.homepage,
            });
          });

          $("#table").bootstrapTable({
            data: items,
          });
        }
      );
      function projectFormatter(value, row, index) {
        return `<a class="text-decoration-none text-reset" href="${row.homepage}">${value}</a><br /><span class="mdi mdi-package package">${row.module_name}</span>`;
      }
      function authorFormatter(value, row, index) {
        return `<a class="text-decoration-none text-reset" href="https://github.com/${row.author}">${value}</a>`;
      }
      function runFormatter(value, row, index) {
        return `<button class="btn btn-link" type="button" data-bs-toggle="modal" data-bs-target="#${
          row.project_link
        }-output">${value}</button>
          <div class="modal fade" id="${row.project_link}-output" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">${
                    row.project_link
                  } 加载日志</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  ${row.output.replace(/\n/g, "<br>")}
                </div>
              </div>
            </div>
          </div>
          `;
      }
      function validFormatter(value, row, index) {
        return `<button class="btn btn-link" type="button" data-bs-toggle="modal" data-bs-target="#${
          row.project_link
        }-valid">${value}</button>
          <div class="modal fade" id="${row.project_link}-valid" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">${
                    row.project_link
                  } 验证日志</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  ${row.validation_message.replace(/\n/g, "<br>")}
                </div>
              </div>
            </div>
          </div>
          `;
      }
      function metadataFormatter(value, row, index) {
        return `<button class="btn btn-link" type="button" data-bs-toggle="modal" data-bs-target="#${
          row.project_link
        }-matadata">${show_log}</button>
          <div class="modal fade" id="${
            row.project_link
          }-matadata" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">${
                    row.project_link
                  } 元数据</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  ${
                    row.metadata !== null
                      ? JSON.stringify(row.metadata, null, "  ").replace(
                          /\n/g,
                          "<br>"
                        )
                      : "无"
                  }
                </div>
              </div>
            </div>
          </div>
          `;
      }
    </script>
  </body>
</html>
