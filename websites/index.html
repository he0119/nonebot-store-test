<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="auto">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>商店测试结果</title>

    <link
      href="https://unpkg.com/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/bootstrap-table@1.22.0/dist/bootstrap-table.min.css"
    />
    <link
      href="https://unpkg.com/@mdi/font@7.2.96/css/materialdesignicons.min.css"
      rel="stylesheet"
    />
    <link href="highlight.css" rel="stylesheet" />

    <style>
      .hljs {
        background: none;
      }
      .ok {
        color: rgb(9, 231, 39);
        font-size: 1.5em;
      }

      .err {
        color: red;
        font-size: 1.5em;
      }

      .show-metadata {
        color: rgb(42, 95, 243);
        font-size: 1.5em;
      }

      .empty-metadata {
        color: rgb(236, 194, 5);
        font-size: 1.5em;
      }

      .package {
        color: rgb(151, 151, 151);
        font-size: 0.95em;
      }

      .account {
        color: rgb(151, 151, 151);
        font-size: 1.5em;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1 class="text-center">商店测试结果</h1>
      <table
        id="table"
        data-show-columns="true"
        data-search="true"
        data-mobile-responsive="true"
        data-check-on-init="true"
        data-pagination="true"
      >
        <thead>
          <tr>
            <th
              data-field="project_link"
              data-formatter="projectFormatter"
              data-sortable="true"
              class="align-middle"
            >
              PyPI 项目名<br /><span class="mdi mdi-package package">包名</span>
            </th>
            <th
              data-field="author"
              data-formatter="authorFormatter"
              data-sortable="true"
              class="align-middle"
            >
              作者
            </th>
            <th
              data-field="valid"
              data-formatter="validFormatter"
              data-sortable="true"
              class="align-middle"
            >
              验证结果
            </th>
            <th
              data-field="run"
              data-formatter="runFormatter"
              data-sortable="true"
              class="align-middle"
            >
              加载结果
            </th>
            <th
              data-field="metadata"
              data-formatter="metadataFormatter"
              data-sortable="true"
              class="align-middle"
            >
              元数据
            </th>
            <th data-field="time" data-sortable="true" class="align-middle">
              测试时间
            </th>
          </tr>
        </thead>
      </table>
    </div>

    <script src="https://unpkg.com/jquery@3.7.0/dist/jquery.min.js"></script>
    <script
      src="https://unpkg.com/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
      crossorigin="anonymous"
    ></script>

    <script src="https://unpkg.com/bootstrap-table@1.22.0/dist/bootstrap-table.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.22.0/dist/locale/bootstrap-table-zh-CN.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.22.0/dist/extensions/mobile/bootstrap-table-mobile.min.js"></script>

    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/highlight.min.js"></script>

    <script src="color-modes.js"></script>
    <script src="ansi_up.js"></script>

    <script>
      const check_pass = `<span class="mdi mdi-check-circle-outline ok"></span>`;
      const check_fail = `<span class="mdi mdi-close-circle-outline err"></span>`;
      const show_metadata = `<span class="mdi mdi-package-variant show-metadata"></span>`;
      const empty_metadata = `<span class="mdi mdi-package-variant-remove empty-metadata"></span>`;
      $.getJSON(
        "https://raw.githubusercontent.com/he0119/nonebot-store-test/main/results/results.json",
        function (data) {
          var items = [];
          $.each(data, function (key, val) {
            items.push({
              time: val.time,
              project_link: val.previous.project_link,
              module_name: val.previous.module_name,
              author: val.previous.author,
              run: val.run ? check_pass : check_fail,
              valid: val.valid ? check_pass : check_fail,
              metadata: val.metadata !== null ? show_metadata : empty_metadata,
              metadata_value: val.metadata,
              output: val.output,
              validation_message: val.valid ? "通过" : val.validation_message,
              homepage: val.previous.homepage,
            });
          });

          $("#table").bootstrapTable({
            data: items,
          });
        }
      );

      function projectKey(row) {
        // 替换 . 为 -，否则会导致 modal 无法正常显示
        return `${row.project_link}-${row.module_name}`.replace(/\./g, "-");
      }

      function projectFormatter(value, row, index) {
        return `<a class="text-decoration-none text-reset" href="${row.homepage}" target="_blank">${value}</a><br /><span class="mdi mdi-package package"><a class="text-decoration-none text-reset" href="https://pypi.org/project/${value}" target="_blank">${row.module_name}</a></span>`;
      }
      function authorFormatter(value, row, index) {
        return `<a class="text-decoration-none text-reset" href="https://github.com/${row.author}" target="_blank">${value}</a>`;
      }
      function runFormatter(value, row, index) {
        return `<button class="btn btn-link" type="button" data-bs-toggle="modal" data-bs-target="#${projectKey(
          row
        )}-output">${value}</button>
          <div class="modal fade" id="${projectKey(row)}-output" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">${
                    row.project_link
                  } 加载日志</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <pre>${log_to_html(row.output)}</pre>
                </div>
              </div>
            </div>
          </div>
          `;
      }
      function validFormatter(value, row, index) {
        return `<button class="btn btn-link" type="button" data-bs-toggle="modal" data-bs-target="#${projectKey(
          row
        )}-valid">${value}</button>
          <div class="modal fade" id="${projectKey(row)}-valid" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">${
                    row.project_link
                  } 验证结果</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <pre>${row.validation_message}</pre>
                </div>
              </div>
            </div>
          </div>
          `;
      }
      function metadataFormatter(value, row, index) {
        return `<button class="btn btn-link" type="button" data-bs-toggle="modal" data-bs-target="#${projectKey(
          row
        )}-matadata">${value}</button>
          <div class="modal fade" id="${projectKey(
            row
          )}-matadata" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">${
                    row.project_link
                  } 元数据</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <pre><code class="language-json">${
                    hljs.highlight(
                      row.metadata_value !== null
                        ? JSON.stringify(row.metadata_value, null, "  ")
                        : "无",
                      { language: "json" }
                    ).value
                  }</code></pre>
                </div>
              </div>
            </div>
          </div>
          `;
      }
      let ansi_up = new AnsiUp();
      function log_to_html(ansi_text) {
        return ansi_up.ansi_to_html(ansi_text);
      }
    </script>
  </body>
</html>
