<!doctype html>
<html lang="zh-CN" data-bs-theme="auto">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>商店测试结果</title>

    <link
      href="https://unpkg.com/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/bootstrap-table@1.22.0/dist/bootstrap-table.min.css"
    />
    <link
      href="https://unpkg.com/@mdi/font@7.2.96/css/materialdesignicons.min.css"
      rel="stylesheet"
    />
    <link href="highlight.css" rel="stylesheet" />

    <style>
      .hljs {
        background: none;
      }

      .ok {
        color: rgb(9, 231, 39);
        font-size: 1.5em;
      }

      .err {
        color: red;
        font-size: 1.5em;
      }

      .show-metadata {
        color: rgb(42, 95, 243);
        font-size: 1.5em;
      }

      .empty-metadata {
        color: rgb(236, 194, 5);
        font-size: 1.5em;
      }

      .package {
        color: rgb(151, 151, 151);
        font-size: 0.95em;
      }

      .account {
        color: rgb(151, 151, 151);
        font-size: 1.5em;
      }

      .nav-item {
        margin-left: 5px;
      }

      .back-to-top {
        position: fixed;
        font-size: 20px;
        bottom: 55px;
        right: 20px;
        opacity: 0;
        background-color: rgba(64, 64, 64, 0.1);
        transition: opacity 0.3s ease-in-out;
      }
    </style>
  </head>

  <body>
    <nav class="navbar bg-body-tertiary sticky-top">
      <div class="container">
        <a class="navbar-brand" href="#">
          <img
            src="https://nonebot.dev/logo.png"
            alt="Logo"
            width="30"
            height="30"
            class="d-inline-block align-text-top"
          />
          商店测试结果
        </a>
        <ul class="navbar-nav flex-row flex-wrap ms-md-auto">
          <li class="nav-item">
            <button class="navbar-toggler" type="button" title="GitHub">
              <a href="https://github.com/nonebot/registry" target="_blank">
                <span class="mdi mdi-github"></span>
              </a>
              <style>
                a {
                  color: inherit;
                }
              </style>
            </button>
          </li>
          <li class="nav-item">
            <button
              class="navbar-toggler"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#result-statistics"
              aria-controls="result-statistics"
              aria-expanded="false"
              aria-label="Toggle navigation"
            >
              <span class="bi bi-bar-chart-line"></span>
            </button>
          </li>
          <li class="nav-item" style="position: relative">
            <button
              class="navbar-toggler dropdown-toggle align-items-center"
              id="bd-theme"
              type="button"
              aria-expanded="false"
              data-bs-toggle="dropdown"
              data-bs-display="static"
              aria-label="Theme"
            >
              <span
                id="theme-toggle-icon"
                class="mdi mdi-theme-light-dark"
              ></span>
            </button>
            <ul
              class="dropdown-menu dropdown-menu-end"
              style="position: absolute; min-width: 5rem"
            >
              <li>
                <button
                  type="button"
                  class="dropdown-item"
                  data-bs-theme-value="light"
                >
                  <span class="mdi mdi-weather-sunny"></span>
                  Light
                </button>
              </li>
              <li>
                <button
                  type="button"
                  class="dropdown-item"
                  data-bs-theme-value="dark"
                >
                  <span class="mdi mdi-weather-night"></span>
                  Dark
                </button>
              </li>
              <li>
                <button
                  type="button"
                  class="dropdown-item"
                  data-bs-theme-value="auto"
                >
                  <span class="mdi mdi-theme-light-dark"></span>
                  Auto
                </button>
              </li>
            </ul>
          </li>
        </ul>
      </div>
      <div class="container">
        <div class="collapse" id="result-statistics" style="width: 100%">
          <div class="p-4">
            <h5 class="text-body-emphasis h4 lh-base">
              <span class="mdi mdi-chart-box-outline"> 测试统计 </span>
            </h5>
            <div class="fw-semibold">
              <span class="mdi mdi-check-decagram-outline">
                验证通过: <span id="total-check-pass">-</span>
              </span>
              <div
                class="progress"
                role="progressbar"
                aria-label="show-check-progress"
                aria-valuemin="0"
                aria-valuemax="100"
                style="height: 5px"
              >
                <div class="progress-bar" id="check-pass-progress"></div>
              </div>
            </div>
            <div class="text-body-secondary">
              <span class="mdi mdi-puzzle-check-outline">
                加载通过: <span id="total-load-pass">-</span>
              </span>
              <div
                class="progress"
                role="progressbar"
                aria-label="show-load-progress"
                aria-valuemin="0"
                aria-valuemax="100"
                style="height: 3px"
              >
                <div class="progress-bar" id="load-pass-progress"></div>
              </div>
            </div>
            <div class="text-body-secondary">
              <span class="mdi mdi-package-variant-closed-check">
                元数据存在: <span id="total-metadata-pass">-</span>
              </span>
              <div
                class="progress"
                role="progressbar"
                aria-label="show-metadata-progress"
                aria-valuemin="0"
                aria-valuemax="100"
                style="height: 3px"
              >
                <div class="progress-bar" id="metadata-pass-progress"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <div class="container">
      <table
        id="table"
        data-show-columns="true"
        data-search="true"
        data-mobile-responsive="true"
        data-check-on-init="true"
        data-pagination="true"
      >
        <thead>
          <tr>
            <th
              data-field="id"
              data-sortable="true"
              data-visible="false"
              class="align-middle"
            >
              序号
            </th>
            <th
              data-field="project_link"
              data-formatter="projectFormatter"
              data-sortable="true"
              class="align-middle"
            >
              PyPI 项目名<br /><span class="mdi mdi-package package">包名</span>
            </th>
            <th
              data-field="author"
              data-formatter="authorFormatter"
              data-sortable="true"
              class="align-middle"
            >
              作者
            </th>
            <th
              data-field="valid"
              data-formatter="validFormatter"
              data-sortable="true"
              class="align-middle"
            >
              验证结果
            </th>
            <th
              data-field="run"
              data-formatter="runFormatter"
              data-sortable="true"
              class="align-middle"
            >
              加载结果
            </th>
            <th
              data-field="metadata"
              data-formatter="metadataFormatter"
              data-sortable="true"
              class="align-middle"
            >
              元数据
            </th>
            <th
              data-field="time"
              data-formatter="timeFormatter"
              data-sortable="true"
              class="align-middle"
            >
              测试时间
            </th>
          </tr>
        </thead>
      </table>
    </div>

    <button
      type="button"
      title="Scroll To Top"
      class="btn btn-light back-to-top"
      onclick="scrollToTop()"
    >
      <span class="mdi mdi-rocket text-primary"></span>
    </button>

    <script src="https://unpkg.com/jquery@3.7.0/dist/jquery.min.js"></script>
    <script
      src="https://unpkg.com/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
      crossorigin="anonymous"
    ></script>

    <script src="https://unpkg.com/bootstrap-table@1.22.0/dist/bootstrap-table.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.22.0/dist/locale/bootstrap-table-zh-CN.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.22.0/dist/extensions/mobile/bootstrap-table-mobile.min.js"></script>

    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/highlight.min.js"></script>

    <script src="color-modes.js"></script>
    <script src="ansi_up.js"></script>

    <script>
      const check_pass = `<span class="mdi mdi-check-circle-outline ok"></span>`;
      const check_fail = `<span class="mdi mdi-close-circle-outline err"></span>`;
      const show_metadata = `<span class="mdi mdi-package-variant show-metadata"></span>`;
      const empty_metadata = `<span class="mdi mdi-package-variant-remove empty-metadata"></span>`;

      const now_time = new Date().getTime();

      $.getJSON("/results.json", function (data) {
        let items = [];
        let id = 1;
        $.each(data, function (key, val) {
          items.push({
            id: id++,
            time: val.time,
            project_link: val.previous.project_link,
            module_name: val.previous.module_name,
            author: val.previous.author,
            run: val.run ? check_pass : check_fail,
            valid: val.valid ? check_pass : check_fail,
            metadata: val.metadata !== null ? show_metadata : empty_metadata,
            metadata_value: val.metadata,
            output: val.output,
            validation_message: val.valid ? "通过" : val.validation_message,
            homepage: val.previous.homepage,
          });
        });

        $("#table").bootstrapTable({
          data: items,
        });

        let $table = $("#table");
        statistics($table);
      });

      function projectKey(row) {
        // 替换 . 为 -，否则会导致 modal 无法正常显示
        return `${row.project_link}-${row.module_name}`.replace(/\./g, "-");
      }

      function timeFormatter(value, row, index) {
        let check_time = new Date(value).getTime();
        const time_diff = now_time - check_time;
        return `<span class="mdi mdi-clock-outline ${time_color(
          time_diff,
        )}">${value}</span>`;
      }

      function projectFormatter(value, row, index) {
        return `<a class="text-decoration-none text-reset" href="${row.homepage}" target="_blank">${value}</a><br /><span class="mdi mdi-package package"><a class="text-decoration-none text-reset" href="https://pypi.org/project/${value}" target="_blank">${row.module_name}</a></span>`;
      }
      function authorFormatter(value, row, index) {
        return `<a class="text-decoration-none text-reset" href="https://github.com/${row.author}" target="_blank">${value}</a>`;
      }
      function runFormatter(value, row, index) {
        return `<button class="btn btn-link" type="button" data-bs-toggle="modal" data-bs-target="#${projectKey(
          row,
        )}-output">${value}</button>
          <div class="modal fade" id="${projectKey(row)}-output" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">${
                    row.project_link
                  } 加载日志</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <pre>${log_to_html(row.output)}</pre>
                </div>
              </div>
            </div>
          </div>
          `;
      }
      function validFormatter(value, row, index) {
        return `<button class="btn btn-link" type="button" data-bs-toggle="modal" data-bs-target="#${projectKey(
          row,
        )}-valid">${value}</button>
          <div class="modal fade" id="${projectKey(row)}-valid" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">${
                    row.project_link
                  } 验证结果</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <pre>${row.validation_message}</pre>
                </div>
              </div>
            </div>
          </div>
          `;
      }
      function metadataFormatter(value, row, index) {
        return `<button class="btn btn-link" type="button" data-bs-toggle="modal" data-bs-target="#${projectKey(
          row,
        )}-matadata">${value}</button>
          <div class="modal fade" id="${projectKey(
            row,
          )}-matadata" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">${
                    row.project_link
                  } 元数据</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <pre><code class="language-json">${
                    hljs.highlight(
                      row.metadata_value !== null
                        ? JSON.stringify(row.metadata_value, null, "  ")
                        : "无",
                      { language: "json" },
                    ).value
                  }</code></pre>
                </div>
              </div>
            </div>
          </div>
          `;
      }

      function statistics($table) {
        total_items = $table.bootstrapTable("getData").length;
        total_check_pass = $table
          .bootstrapTable("getData")
          .filter((item) => item.valid === check_pass).length;
        total_load_pass = $table
          .bootstrapTable("getData")
          .filter((item) => item.run === check_pass).length;
        total_metadata_exist = $table
          .bootstrapTable("getData")
          .filter((item) => item.metadata === show_metadata).length;

        set_statistics("check", total_check_pass, total_items);
        set_statistics("load", total_load_pass, total_items);
        set_statistics("metadata", total_metadata_exist, total_items);
      }

      function set_statistics(id, pass_count, total) {
        rate = (pass_count / total) * 100;
        $(`#total-${id}-pass`).text(`${pass_count}/${total}`);
        $(`#${id}-pass-progress`).css("width", `${rate}%`);
        $(`#${id}-pass-progress`).addClass(progress_color(rate));
      }

      function progress_color(rate) {
        if (rate >= 80) {
          return "bg-success";
        } else if (rate >= 60) {
          return "bg-info";
        } else if (rate >= 40) {
          return "bg-warning";
        } else {
          return "bg-danger";
        }
      }

      function time_color(time_diff) {
        if (time_diff <= 3600000) {
          // 1 小时内更新是红色
          return "text-danger";
        } else if (time_diff <= 7200000) {
          // 2 小时内更新是黄色
          return "text-warning";
        } else if (time_diff >= 2592000) {
          // 30 天以上更新是灰色
          return "text-secondary";
        } else {
          // 2 小时以上更新是正常
          return "";
        }
      }

      let ansi_up = new AnsiUp();
      function log_to_html(ansi_text) {
        return ansi_up.ansi_to_html(ansi_text);
      }

      function scrollToTop() {
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      window.addEventListener("scroll", function () {
        let backToTopBtn = document.querySelector(".back-to-top");
        if (window.pageYOffset > document.documentElement.scrollHeight / 10) {
          backToTopBtn.style.opacity = "0.7";
        } else {
          backToTopBtn.style.opacity = "0";
        }
      });
    </script>
  </body>
</html>
